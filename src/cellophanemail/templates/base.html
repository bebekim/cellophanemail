<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CellophoneMail - AI-Powered Email Protection{% endblock %}</title>
    
    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Hotwire Turbo -->
    <script type="module">
        import hotwiredTurbo from 'https://cdn.skypack.dev/@hotwired/turbo';
    </script>
    
    <!-- Hotwire Stimulus -->
    <script type="module">
        import { Application, Controller } from 'https://cdn.skypack.dev/@hotwired/stimulus';
        
        window.Stimulus = Application.start();
        
        // Base controller class
        window.Controller = Controller;
        
        // CSRF Token Helper
        document.addEventListener('DOMContentLoaded', () => {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            
            // Add CSRF token to all forms
            document.querySelectorAll('form').forEach(form => {
                if (!form.querySelector('input[name="csrf_token"]') && csrfToken) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = csrfToken;
                    form.appendChild(input);
                }
            });
            
            // Add CSRF header and JWT auth to fetch requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                let [url, options = {}] = args;
                
                options.headers = options.headers || {};
                
                // Add CSRF header for state-changing requests
                if (options.method && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(options.method.toUpperCase())) {
                    options.headers['X-CSRF-Token'] = csrfToken;
                }
                
                // Add JWT Authorization header if token exists
                const accessToken = localStorage.getItem('access_token');
                if (accessToken) {
                    options.headers['Authorization'] = `Bearer ${accessToken}`;
                }
                
                return originalFetch(url, options);
            };
            
            // Navigation styling based on page
            setupNavigationStyling();
            
            // Authentication state management
            checkAuthenticationState();
            
            function setupNavigationStyling() {
                const globalNav = document.getElementById('global-nav');
                if (!globalNav) return;
                
                // Apply different styles based on the current page
                if (window.location.pathname === '/') {
                    // Landing page: absolute position, transparent background
                    globalNav.className = 'nav-bar absolute inset-x-0 top-0 z-50';
                } else {
                    // Other pages: normal navigation bar with background
                    globalNav.className = 'nav-bar bg-white shadow-sm dark:bg-gray-800 dark:shadow-none dark:border-b dark:border-gray-700';
                }
            }
            
            // Function to check if user is authenticated and show/hide navigation elements
            function checkAuthenticationState() {
                const accessToken = localStorage.getItem('access_token');
                const authButtons = document.getElementById('auth-buttons');
                const userMenu = document.getElementById('user-menu');
                const userEmailSpan = document.getElementById('user-email');
                const navLinks = document.getElementById('nav-links');
                
                if (accessToken) {
                    // User is authenticated - show user menu, hide auth buttons
                    try {
                        const payload = JSON.parse(atob(accessToken.split('.')[1]));
                        if (payload.email && userEmailSpan) {
                            userEmailSpan.textContent = payload.email;
                        }
                        
                        if (authButtons) authButtons.style.display = 'none';
                        if (userMenu) userMenu.style.display = 'flex';
                        
                        // Hide landing page nav links when authenticated (unless on landing page)
                        if (navLinks && window.location.pathname !== '/') {
                            navLinks.style.display = 'none';
                        }
                    } catch (e) {
                        // Token is malformed, show unauthenticated state
                        showUnauthenticatedState();
                    }
                } else {
                    // User is not authenticated - show auth buttons, hide user menu
                    showUnauthenticatedState();
                }
            }
            
            function showUnauthenticatedState() {
                const authButtons = document.getElementById('auth-buttons');
                const userMenu = document.getElementById('user-menu');
                const navLinks = document.getElementById('nav-links');
                
                if (authButtons) authButtons.style.display = 'flex';
                if (userMenu) userMenu.style.display = 'none';
                
                // Show landing page nav links only on landing page
                if (navLinks && window.location.pathname === '/') {
                    navLinks.style.display = 'flex';
                } else if (navLinks) {
                    navLinks.style.display = 'none';
                }
            }
            
            // Global sign out function
            window.signOut = async function() {
                try {
                    const accessToken = localStorage.getItem('access_token');
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                    
                    // Call logout endpoint if we have a token
                    if (accessToken) {
                        await fetch('/api/v1/auth/logout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${accessToken}`,
                                'X-CSRF-Token': csrfToken
                            }
                        });
                    }
                } catch (error) {
                    console.log('Logout request failed, but clearing local storage anyway');
                } finally {
                    // Always clear local storage and redirect
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = '/auth/login';
                }
            };
        });
    </script>
    
    {% block head %}{% endblock %}
</head>
<body class="h-full bg-white dark:bg-gray-900">
    <!-- Global Navigation -->
    <nav id="global-nav" class="nav-bar">
        <div class="mx-auto max-w-7xl px-6 py-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex lg:flex-1">
                    <a href="/" class="-m-1.5 p-1.5">
                        <span class="text-2xl font-bold text-gray-900 dark:text-white">CellophoneMail</span>
                    </a>
                </div>
                
                <!-- Navigation Links (for landing page) -->
                <div id="nav-links" class="hidden lg:flex lg:gap-x-8">
                    <a href="#features" class="text-sm font-semibold text-gray-900 hover:text-gray-600 dark:text-white dark:hover:text-gray-300">Features</a>
                    <a href="#how-it-works" class="text-sm font-semibold text-gray-900 hover:text-gray-600 dark:text-white dark:hover:text-gray-300">How It Works</a>
                    <a href="#pricing" class="text-sm font-semibold text-gray-900 hover:text-gray-600 dark:text-white dark:hover:text-gray-300">Pricing</a>
                </div>
                
                <!-- Unauthenticated state: Login/Signup -->
                <div id="auth-buttons" class="flex lg:flex-1 lg:justify-end gap-x-4">
                    <a href="/auth/login" class="text-sm font-semibold text-gray-900 hover:text-gray-600 dark:text-white dark:hover:text-gray-300">Log in</a>
                    <a href="/auth/register" class="rounded-md bg-indigo-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Sign up</a>
                </div>
                
                <!-- Authenticated state: User info and Sign Out -->
                <div id="user-menu" class="flex lg:flex-1 lg:justify-end items-center space-x-4" style="display: none;">
                    <span id="user-email" class="text-sm text-gray-600 dark:text-gray-400"></span>
                    <button type="button" onclick="signOut()" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 dark:bg-indigo-500 dark:hover:bg-indigo-400">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    {% block content %}{% endblock %}
    
    {% block scripts %}{% endblock %}
</body>
</html>