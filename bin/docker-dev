#!/usr/bin/env bash
# Docker-based development environment launcher

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}üê≥ Starting CellophoneMail Docker Environment${NC}"

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ùå Docker is not running${NC}"
    echo "Please start Docker Desktop or Docker daemon"
    exit 1
fi

# Check if .env exists, create from .env.docker if not
if [ ! -f .env ]; then
    if [ -f .env.docker ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  .env not found, copying from .env.docker${NC}"
        cp .env.docker .env
        echo -e "${YELLOW}‚ö†Ô∏è  Please edit .env and add your ANTHROPIC_API_KEY${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  .env.docker not found, please create .env manually${NC}"
        exit 1
    fi
fi

# Build and start services
echo -e "${BLUE}Building Docker images...${NC}"
docker-compose build

echo -e "${BLUE}Starting services...${NC}"
docker-compose up -d

# Wait for services to be healthy
echo -e "${BLUE}Waiting for services to be ready...${NC}"
sleep 5

# Run migrations
echo -e "${BLUE}Running database migrations...${NC}"
docker-compose exec app uv run piccolo migrations forwards cellophanemail || true

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}‚úÖ Docker environment is running!${NC}"
echo -e "${GREEN}============================================${NC}"
echo -e "${YELLOW}üìñ API Server: http://localhost:8000${NC}"
echo -e "${YELLOW}üìñ API Docs: http://localhost:8000/schema${NC}"
echo -e "${YELLOW}üìß SMTP Server: localhost:2525${NC}"
echo -e "${YELLOW}üóÑÔ∏è  PostgreSQL: localhost:5433${NC}"
echo -e "${GREEN}============================================${NC}"
echo -e "${BLUE}View logs: docker-compose logs -f${NC}"
echo -e "${BLUE}Stop services: docker-compose down${NC}"
echo -e "${BLUE}Stop and clean: ./bin/docker-clean${NC}"
